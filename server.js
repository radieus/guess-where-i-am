const path = require('path');
const http = require('http');
const express = require('express');
const mongoose = require('mongoose');
const { Game } = require('./models/game');
const cookieParser = require('cookie-parser');
const { User } = require('./models/user');
const jwt = require("jsonwebtoken");
const _ = require('lodash');
const mongo = require('./config/db');
const users = require('./routes/users');
const games = require('./routes/games');
const auth = require('./routes/auth');
const jwt_auth = require('./middleware/auth');

require('dotenv').config();

var latGoal;
var lngGoal;
var pointsArray = [];

var coordArray = ['45.5879673, -73.6341011', '49.766738, -94.490688', '42.30993, -82.467577', '52.0984371, -106.5679915', '43.766481, -79.190789', '49.2327652, -124.8072662', '43.229864, -79.881303', '44.7426883, -81.1408477', '43.96514, -79.270197', '42.593701, -82.385044', '51.468192, -109.15569', '43.760016, -79.224703', '44.733596, -63.655762', '45.0170505, -75.6611658', '49.2852735, -123.1137934', '43.6520219, -79.3648562', '45.473429, -73.4701411', '43.798109, -79.151708', '43.0497159, -79.2740199', '49.2336573, -123.0349681', '53.265378, -113.551949', '48.370548, -53.360038', '48.439326, -123.506933', '52.157437, -106.67318', '43.609465, -79.745554', '49.8628115, -119.4912422', '43.836124, -79.253054', '45.8876637, -72.5051445', '45.452979, -75.483511', '49.133612, -122.843192', '49.6618309, -103.8543218', '43.579322, -79.683608', '45.271692, -75.2842663', '45.5213345, -73.6141247', '43.8453192, -79.5548728', '49.2489, -123.185264', '49.3471931, -124.4434003', '46.2611589, -81.7775316', '45.5655274, -73.9061139', '45.655432, -60.877488', '51.0612378, -99.5239113', '49.270862, -100.991774', '44.698402, -63.580503', '51.643614, -111.926189', '43.713696, -79.399852', '43.0254087, -80.3740951', '43.419939, -80.449785', '47.433923, -53.165653', '45.4677325, -73.6383274', '43.6891455, -79.8360007', '43.2662054, -79.9548678', '52.291603, -113.813826', '49.894118, -97.1966458', '44.308307, -79.5766308', '51.1509702, -114.2143664', '52.463108, -113.731757', '49.7016298, -112.8259932', '51.175243, -114.10895', '45.4110788, -75.6929581', '51.6280529, -106.4396324', '45.6051791, -73.5520943', '48.805326, -79.201962', '43.7706144, -79.7796944', '43.5785904, -79.6859436', '44.032214, -79.475114', '45.404274, -75.689091', '45.142563, -61.982975', '46.333233, -79.463272', '53.823618, -101.251072', '45.2713776, -75.9323688', '42.779004, -81.197848', '55.7414511, -97.8530416', '45.56038, -62.711318', '43.6705194, -79.2978141', '51.4596759, -112.7135468', '46.509092, -84.32968', '49.125212, -122.705223', '45.3823681, -73.9920295', '43.357562, -79.81007', '49.0954996, -116.513285', '49.555563, -99.292717', '43.4251561, -80.5527142', '43.4517832, -80.4419433', '43.67888, -79.345045', '43.24093, -79.85182', '52.1173294, -106.6568549', '45.043885, -63.147502', '47.6569227, -52.7296322', '43.621391, -79.524853', '47.002851, -65.565505', '49.15747, -122.779345', '47.857243, -53.355216', '45.822761, -66.646641', '42.2931487, -82.7080229', '42.095168, -82.462374', '44.646072, -81.118582', '43.6702311, -79.3867468', '43.5395944, -80.2798179', '45.3571898, -75.65365', '50.180595, -100.596199', '49.8823677, -97.12219', '45.391865, -73.515575', '43.123712, -79.2006', '43.660207, -79.388956', '49.232853, -124.807527', '43.645053, -79.567383', '50.6474449, -104.866682', '50.976985, -114.015701', '45.274288, -75.8692322', '49.1400908, -123.1367034', '49.6823218, -103.0246777', '48.8268704, -124.0512659', '45.500378, -73.508976', '45.1335736, -71.8031268', '45.225386, -75.68452', '45.273409, -66.059059', '54.442622, -124.246664', '43.0248895, -79.3607867', '49.340087, -123.032516', '45.538144, -73.6990927', '43.906623, -78.811864', '43.685643, -79.313013', '56.2494272, -120.8474927', '49.2412499, -98.5376612', '49.32206, -123.097307', '50.802165, -103.544662', '46.0384575, -73.7013712', '45.0273248, -74.7022032', '43.396251, -80.359153', '48.47681, -81.328338', '43.706166, -80.377602', '50.78043, -101.287934', '45.6532621, -73.5107133', '50.928651, -102.805988', '45.427271, -73.310693', '45.392453, -61.498942', '49.2682533, -123.1596412', '43.996515, -80.914609', '55.169653, -118.787441', '43.442367, -80.414325', '43.642658, -79.427523', '54.153932, -113.860174', '52.269015, -113.813625', '49.617105, -100.260158', '46.212269, -82.071927', '45.4372764, -73.7058658', '51.228941, -101.355371', '43.028269, -81.277215', '46.0412817, -73.7055024', '45.086528, -63.408309', '51.2914551, -114.0134527', '49.3075548, -122.9530871', '49.0139687, -88.2635979', '43.8220607, -79.3975927', '45.938734, -66.660305', '44.690357, -63.883002', '43.3589, -80.313433', '43.808906, -79.271037', '47.553298, -52.781109', '44.671653, -63.489615', '48.776881, -123.701395', '49.1845694, -123.0950125', '43.847885, -79.536312', '45.370513, -75.769917', '48.547919, -58.5809802', '45.5847618, -73.605617', '42.096683, -83.108052', '43.620317, -79.673457', '43.656554, -79.407383', '50.4956564, -104.6649948', '45.218593, -81.563578', '49.166167, -123.136474', '46.7733057, -71.2767898', '44.18893, -66.160172', '52.462987, -113.731791', '43.51765, -79.876434', '49.116705, -122.67075', '49.2584303, -123.1530716', '43.957882, -78.318792', '44.428386, -65.996933', '43.844328, -79.018594', '43.598202, -79.783313', '53.495505, -113.665314', '52.331018, -109.942031', '49.104501, -122.799299', '49.3273179, -123.1377724', '50.229816, -99.465623', '48.9517544, -57.9424935', '52.008912, -110.77534', '43.867494, -79.362587', '45.020065, -74.729615', '45.492803, -73.557572', '45.401679, -75.7271', '43.3257868, -79.7934881', '49.8238322, -97.1140968', '45.359534, -73.724575', '43.6464567, -79.9221226', '48.066327, -66.372335', '52.244273, -113.814102', '43.7261144, -79.2314591', '44.900683, -76.021278', '46.391357, -63.789514', '49.0746909, -122.6680418', '43.445948, -80.572448', '45.566437, -73.5536001', '49.262682, -122.781281', '42.0382632, -82.7396055', '44.231389, -76.481342', '43.196789, -79.869886', '49.1904568, -123.9668128', '43.037926, -80.882301', '45.288166, -75.671542', '45.4342273, -75.6117483', '43.458169, -79.677441', '43.059275, -79.051353', '49.38018, -102.755894', '42.2871, -83.057722', '45.42237, -64.526942', '44.583732, -78.191368', '45.305941, -75.922759', '44.188601, -66.161447', '50.566656, -111.898844', '46.233469, -63.126454', '51.0907647, -115.3550167', '44.005106, -79.825714', '49.1333682, -122.8904358', '48.424274, -123.365431', '46.577418, -81.197703', '49.04944, -122.338158', '44.276974, -76.718559', '43.912889, -80.126588', '48.4278708, -71.0650202', '51.6454411, -121.2950691', '43.0115346, -81.3345244', '49.230751, -123.00662', '48.448077, -89.233906', '45.472073, -76.684283', '43.1889503, -79.2290094', '42.952626, -81.331005', '49.0902523, -123.0794946', '43.653014, -79.397748', '43.784866, -79.566478', '50.942874, -114.046355', '55.349105, -118.784525', '45.676069, -62.709765', '53.453966, -113.562971', '43.689366, -79.296563', '45.1925599, -67.2781923', '49.884299, -119.493216', '45.5408723, -73.6417826', '44.0747061, -79.4851774', '50.434873, -100.590684', '43.659271, -79.38245', '43.649346, -79.925953', '43.014619, -82.365987', '43.6562918, -79.407288', '44.665817, -63.513537', '45.4849909, -73.6280959', '45.251801, -66.100102', '45.622494, -61.990277', '43.5421326, -79.8708217', '45.477341, -75.69803', '49.184405, -99.663531', '43.449787, -80.489089', '49.88195, -97.294051', '43.0976895, -81.9999681', '49.785173, -112.145178', '45.3484728, -80.0318795', '43.784183, -79.445621', '45.4954547, -73.6648938', '43.1719708, -79.2730756', '49.334331, -123.179762', '50.92391, -114.070203', '42.98277, -81.249228', '51.101397, -114.071472', '49.6943844, -112.8382808', '51.124118, -113.947685', '49.1720019, -123.1338713', '50.134987, -97.326631', '49.272801, -122.756182', '44.1764663, -81.6356592', '44.6808842, -63.5396499', '49.896543, -97.158772', '44.067269, -79.427611', '53.5407664, -113.4939784', '50.619528, -108.457808', '49.850652, -100.93299', '43.857718, -79.324043', '46.470048, -64.724155', '48.9556919, -54.608964', '46.7937348, -71.1792844', '43.72277, -79.415871', '51.807202, -103.152114', '50.998806, -118.19526', '49.863752, -97.19724', '53.525199, -113.565718', '48.380852, -89.273596', '44.65807, -63.597725', '43.2575578, -79.8720799', '48.5906085, -85.2807723', '49.896423, -97.058694', '49.1705614, -123.1824', '52.436883, -111.784112', '49.172592, -97.939121', '43.7719304, -79.6267742', '44.3897288, -79.7029578', '50.4221252, -101.0480211', '51.047898, -114.185313', '51.090503, -115.355286', '43.418291, -80.308626', '43.748436, -79.702246', '45.745308, -73.453677', '46.7630809, -71.3684898', '53.5234227, -113.6676333', '43.219563, -79.842706', '43.969778, -80.97898', '48.467285, -89.182181', '53.915806, -122.750782', '49.9116454, -97.0814413', '44.039, -64.715014', '46.682633, -64.862119', '49.179348, -101.263322', '49.2824888, -122.8272023', '46.098054, -70.651655', '43.521226, -79.679505', '45.4462195, -73.8165536', '42.6840562, -81.7983952', '43.879872, -79.393913', '49.219059, -122.657391', '49.841781, -124.518579', '43.668754, -79.337691', '45.722879, -65.505789', '48.442549, -123.469347', '50.655365, -102.078481', '43.173767, -80.239634', '43.689425, -79.620494', '44.3903281, -79.691079', '53.570368, -113.403346', '43.683625, -79.565833', '51.1657698, -103.4958298', '48.451289, -68.527468', '49.862639, -97.132431', '49.319248, -124.313636', '43.860498, -79.025592', '45.5019407, -73.5680717', '43.619916, -79.485518', '45.540335, -73.508463', '45.5017697, -73.5766349', '49.047081, -122.786319', '51.126102, -114.071327', '43.1235982, -79.2006335', '60.8092209, -115.7892064', '46.249113, -60.087198', '45.7108735, -73.5122647', '49.892353, -97.146879', '54.434479, -110.207319', '45.5400341, -75.3025239', '45.62212, -74.594716', '51.0755, -113.95831', '52.96958, -113.373744', '49.225339, -123.065754', '52.835325, -110.859025', '45.298184, -66.027774', '49.470858, -123.760841', '43.74945, -79.740076', '49.338, -123.102655', '45.420909, -75.638057', '55.339106, -123.09452', '45.5446126, -73.595303', '49.175253, -122.890126', '49.2129196, -122.9207541', '43.1663769, -79.4763715', '44.3087155, -77.7961391', '49.2802743, -122.9675705', '46.370564, -72.5583474', '43.6579464, -79.8173107', '49.2813319, -123.0996276', '45.5393815, -73.6136642', '50.24001, -113.151241', '45.398245, -71.938375', '42.90792, -81.492419', '49.2638471, -123.2092701', '43.8448307, -79.4095065', '50.725988, -113.983015', '42.7730216, -80.9831104', '43.659123, -79.722808', '44.566011, -80.942871', '51.0488372, -113.8279422', '49.269186, -123.044147', '53.541275, -113.301374', '43.718825, -79.638815', '50.666556, -120.351513', '43.581524, -79.713502', '46.492109, -80.995093', '44.022208, -79.805847', '43.594526, -79.639574', '43.704816, -79.388767', '51.463849, -112.709516', '45.4679087, -73.5440349', '48.577642, -123.448803', '49.797983, -97.1983647', '43.679569, -79.435376', '44.355618, -79.6951126', '49.230714, -100.055752', '51.467194, -109.154253', '43.247815, -79.84029', '50.802585, -106.149237', '48.422435, -71.242002', '43.77599, -79.653947', '54.3127373, -130.3268241', '49.491583, -117.295054', '51.1743898, -114.1082464', '44.648475, -63.573555', '53.424913, -113.519364', '43.736565, -79.343382', '45.4976752, -73.811328', '43.677684, -79.496306', '49.140776, -121.96588', '49.608147, -114.44108', '49.941785, -97.157703', '43.138183, -80.268274', '46.310552, -79.464186', '43.726782, -79.795425', '46.089196, -64.774753', '45.091446, -64.362221', '51.190103, -114.468548', '45.522346, -73.783027', '49.269854, -100.992739', '49.134403, -122.306948', '52.286524, -113.770144', '45.4876556, -75.7452981', '43.555604, -79.581782', '45.4986262, -73.6274476', '43.012241, -81.241583', '49.9389778, -97.1159963', '46.099384, -64.804375', '51.79585, -114.133622', '46.53738, -84.365875', '50.450387, -104.609765', '49.9730624, -98.2890319', '49.2636531, -123.1384552', '49.2190757, -123.1175374', '45.6044616, -73.7300664', '54.5167439, -128.5902163', '44.289877, -78.297741', '44.6088969, -79.4537901', '45.558768, -62.659954', '42.7787127, -81.1662239', '48.456372, -123.374358', '43.2309716, -79.8016122', '53.864209, -122.7841225', '45.735621, -73.455995', '49.215561, -123.097865', '43.744096, -81.710622', '49.0456336, -122.223823', '44.744387, -63.2838', '44.608243, -79.416979', '45.3980691, -75.6226292', '46.0567031, -71.9559006', '43.675582, -79.358304', '42.333467, -82.940954', '43.44959, -79.703863', '43.753203, -79.358566', '46.87335, -71.332239', '53.602112, -115.020076', '43.951762, -78.294746', '51.650686, -121.289964', '45.4934803, -73.6384331', '51.009533, -114.082184', '43.684971, -79.523675', '43.540134, -80.2794881', '45.6036459, -76.4913775', '49.602786, -119.666438', '45.278375, -66.076589', '45.268915, -75.747112', '43.54622, -79.591897', '44.614198, -63.616302', '44.3541118, -78.7408416', '49.21795, -122.601896', '52.30469, -114.076145', '52.128814, -106.635775', '43.781875, -79.29246', '60.719289, -135.056555', '43.74687, -79.383948', '43.650247, -79.480325', '45.423043, -75.696917', '51.2689069, -113.9981718', '43.704989, -79.374898', '44.589204, -75.684928', '45.2346826, -76.1838307', '45.479265, -75.512379', '49.104198, -122.725845', '49.269298, -123.069674', '49.2549538, -123.2358576', '43.7867975, -79.3284627', '43.5648014, -80.2777994', '50.247825, -99.838716', '48.002708, -66.683322', '43.44649, -80.5708', '45.4850051, -73.628175', '50.10752, -102.83716', '45.6324567, -73.8155557', '45.4350285, -73.8430386', '49.888974, -119.38975', '54.1400187, -115.7062277', '43.826807, -79.426879', '49.477627, -111.440736', '44.5249118, -80.0005131', '43.728138, -79.288412', '43.1290233, -80.757082', '44.11449, -79.563969', '43.799492, -79.196469', '49.841247, -97.152943', '45.0911, -64.362179', '49.839209, -99.961804', '43.775871, -79.343836', '52.130882, -106.726599', '51.168008, -103.4957944', '50.206123, -66.385027', '43.8682163, -79.2277944', '54.0170684, -124.0091915', '44.4079304, -79.7063035', '42.32627, -82.980643', '45.653287, -73.510867', '43.650236, -79.902477', '44.942743, -65.068349', '49.0260582, -123.0687635', '43.605662, -79.651164', '51.0979805, -113.9548721', '43.610969, -79.60007', '50.1429478, -101.0345077', '43.948333, -78.894448', '51.095293, -114.141215', '52.677448, -113.577843', '45.430937, -73.632604', '50.974633, -114.071691', '43.661226, -79.429076', '50.72881, -103.203338', '51.64358, -111.925557', '49.2344894, -123.1592636', '42.958206, -81.624879', '45.7250186, -73.6191572', '45.99163, -66.650663', '43.6061204, -79.6487951', '53.864209, -122.783756', '43.703886, -79.452465', '51.0690263, -113.9948543', '50.1436322, -96.8743951', '43.915932, -78.95509', '50.5326171, -103.6688969', '43.584031, -81.513721', '45.2716975, -75.2844646', '43.825566, -79.351625', '43.844219, -79.6289581', '45.6673803, -73.8704341', '43.545716, -79.592252', '45.433155, -76.354761', '45.0783098, -64.4963293', '43.663224, -79.383875', '43.595028, -79.639432', '49.2633372, -122.8380297', '43.496877, -79.872665', '43.93936, -78.850533', '43.8796902, -79.7384038', '44.725242, -63.695333', '51.0388161, -114.2003319', '46.0531155, -61.296439', '46.1854286, -82.9548263', '43.686035, -79.760128', '45.364276, -63.273312', '51.924037, -107.134935', '51.0095596, -114.0822144', '43.461663, -80.538494', '42.9022105, -79.6178696', '45.442456, -75.643997', '42.980176, -82.354721', '43.896004, -79.034139', '43.663173, -79.402278', '43.3981667, -79.7626648', '50.820144, -119.688342', '44.3817366, -77.9788284', '51.3461385, -105.436677', '43.6563278, -79.7389205', '43.780869, -79.416168', '45.6379985, -72.962773', '47.620598, -65.652202', '53.454006, -113.513678', '45.529312, -73.346061', '43.554336, -79.64632', '47.5335533, -52.8396098', '43.770644, -80.064448', '50.5812422, -113.8727867', '49.745934, -107.489784', '58.7706757, -94.1682766', '46.2297451, -61.3063772', '45.5333513, -73.5741877', '50.012074, -120.98709', '49.512921, -115.7675537', '45.4603961, -73.5672269', '45.5988385, -73.5691784', '52.027914, -113.949981', '44.380987, -66.079243', '45.3366983, -75.9090717', '45.304918, -73.250788', '45.275549, -75.71928', '43.726019, -79.417124', '45.051133, -63.222413', '50.580484, -113.872261', '48.429803, -123.364472', '49.3109184, -123.0789964', '46.682512, -64.862141', '43.525833, -79.688607', '43.545809, -80.249069', '45.897616, -64.368435', '45.1387967, -76.1446243', '49.88565, -97.169495', '45.4433514, -73.6156462', '43.463658, -80.521947', '49.030814, -122.80112', '51.04822, -105.819669', '43.8239557, -79.5556771', '42.658534, -82.506577', '46.3689497, -79.9295498', '50.039669, -110.675896', '43.90011, -78.938675', '46.842832, -71.249742', '48.4811056, -123.3947876', '44.2834428, -78.3392935', '48.577899, -123.449657', '45.061237, -64.600359', '43.662699, -65.799439', '43.639732, -79.380966', '43.646832, -79.384393', '43.70838, -79.398736', '49.2632383, -123.1150306', '45.5191633, -73.5962436', '43.8479, -79.459363', '49.032336, -122.867542', '46.8127551, -71.215062', '49.1113852, -121.9578961', '44.641224, -63.583742', '43.895507, -79.442951', '45.5167904, -73.6414542', '46.196089, -59.957846', '45.653179, -64.045366', '45.3264914, -75.8356797', '52.848998, -104.047851', '44.238584, -76.5676', '43.838072, -66.1196955', '50.498345, -99.915741', '52.201439, -105.122938', '43.723366, -79.599316', '51.0814121, -114.0254715', '51.0332265, -114.0715346', '49.2852607, -123.1198534', '43.6184014, -80.1435642', '45.393976, -75.749666', '43.703722, -79.412661', '45.577455, -73.446767', '53.4249131, -113.4225378', '47.5614464, -52.7456273', '44.0122693, -79.414703', '45.5083059, -73.6252082', '43.071897, -80.11797', '43.205936, -79.907237', '49.324953, -123.072246', '45.2988727, -74.6266663', '49.208792, -123.140629', '49.832752, -97.047628', '49.632855, -102.267714', '46.209309, -60.248454', '44.306048, -78.320093', '44.97378, -81.280565', '46.0480363, -74.2884745', '50.134905, -97.295555', '49.900262, -97.1379', '47.5637093, -52.70741', '51.0218389, -114.1427557', '55.431767, -116.491472', '50.286348, -107.801459', '46.803321, -71.221784', '42.9573501, -81.2606362', '43.71182, -79.428011', '43.808228, -79.462512', '43.6593717, -79.6531454', '45.392785, -61.49904', '49.191883, -123.1737778', '44.646244, -63.573566', '43.3782421, -80.7102485', '54.268269, -110.74311', '49.6983467, -112.894074', '45.961948, -66.640726', '51.488478, -107.052562', '50.4807209, -104.6165302', '49.188088, -122.845541', '49.2184045, -122.9528181', '46.634586, -61.008861', '44.644574, -63.600083', '43.612386, -79.5804307', '45.5910301, -73.7851538', '43.717317, -79.636474', '48.4692727, -123.3327297', '51.038198, -113.3774498', '51.0529955, -113.9568003', '43.584973, -79.644979', '50.021524, -119.404098', '43.65201, -79.397857', '51.176592, -114.146704', '49.668569, -124.978339', '52.1050894, -101.2705177', '43.449122, -79.759139', '47.615053, -52.712924', '42.786612, -80.203374', '48.758424, -80.683637', '49.281021, -123.006278', '44.078538, -80.2047602', '50.819879, -119.688552', '45.507971, -73.56323', '50.4590943, -104.6065337', '45.8428071, -66.5037605', '49.270402, -122.75631', '50.258211, -96.059138', '52.0275868, -113.9501303', '52.147506, -106.572758', '44.286461, -78.321896', '49.8540517, -97.0713621', '51.644859, -120.072688', '44.0909169, -79.1329785', '45.5420767, -73.7494859', '48.2417605, -79.025897', '45.3335391, -73.2931559', '45.4606949, -73.8228984', '50.0993538, -122.9814237', '43.760204, -79.727417', '43.635045, -79.541007', '53.426088, -113.479955', '44.9161055, -75.8364471', '45.3337, -76.290479', '43.158246, -79.246413', '43.2162874, -79.9896404', '45.348106, -73.586964', '50.674044, -120.334068', '53.629247, -113.481529', '49.241534, -123.0575753', '43.599991, -80.557992', '44.6985535, -76.1895653', '43.4890254, -79.8617661', '44.994548, -64.139597', '46.903555, -67.396344', '44.733483, -63.655635', '43.00963, -80.055794', '45.5025895, -73.5722891', '43.354307, -80.286845', '48.003005, -66.682754', '52.9790171, -122.4968385', '50.653063, -102.074926', '49.838218, -101.523499', '45.2046533, -72.7467175', '51.2300397, -101.3542539', '44.496011, -80.216065', '44.6998735, -63.6882628', '53.384627, -117.621755', '44.182324, -76.777015', '43.420925, -65.620123', '49.2260788, -122.9922921', '43.697453, -79.329069', '45.593093, -73.6668168', '43.792933, -79.353783', '44.774042, -63.693116', '45.01039, -65.089224', '45.460854, -73.466942', '45.434945, -73.843173', '45.4559168, -73.8620538', '45.342722, -75.763039', '43.680437, -79.288299', '48.444808, -123.335291', '43.761554, -80.745884', '49.485645, -113.948187', '42.9919266, -79.2495848', '48.6489414, -123.3971622', '69.117476, -105.054131', '43.129901, -80.758077', '43.608618, -79.689829', '43.9434345, -79.4544117', '45.4823444, -73.7950796', '43.728993, -79.403221', '44.9871421, -81.2542783', '43.2526866, -79.0831993', '47.582482, -52.712076', '43.65554, -79.383898', '49.878719, -97.217876', '43.8528241, -79.2547839', '48.3495957, -64.6778281', '54.154481, -113.860052', '44.565604, -80.942787', '49.277474, -122.802423', '45.198617, -72.758639', '44.392856, -65.94119', '51.045755, -114.070074', '44.1817726, -77.3931639', '49.289868, -123.137862', '43.7697469, -79.5205913', '43.7925525, -79.5321216', '49.731229, -114.886709', '45.5908731, -73.7864303', '51.053153, -113.956508', '51.0239833, -114.1078784', '43.517554, -79.622833', '43.697649, -79.799773', '53.804811, -113.643286', '46.136323, -60.194131', '44.6297298, -81.2610176', '44.6988434, -63.6651085', '52.127824, -106.666099', '45.4459768, -73.4392231', '43.251207, -79.813519', '49.478163, -111.440806', '51.201734, -108.033156', '42.234921, -82.5525778', '43.855559, -79.430175', '45.515082, -73.683975', '42.909764, -81.299379', '44.546391, -64.723747', '44.10484, -78.944004', '62.453193, -114.374803', '43.594075, -79.535338', '49.279983, -123.123894', '43.0060327, -81.3039566', '42.405439, -82.187415', '53.51806, -113.510898', '43.208617, -79.650664', '43.68607, -79.375844', '48.4278453, -71.0651382', '49.857754, -97.170033', '43.8057955, -79.3847281', '43.257235, -79.877327', '43.0012287, -81.1883591', '43.135936, -79.526885', '53.2223659, -114.9772323', '48.8788517, -72.2289519', '49.848426, -99.9481103', '53.543928, -113.930238', '45.619079, -79.408305', '51.04852, -114.067007', '52.1294032, -122.1406628', '51.001391, -114.056411', '49.056515, -122.801075', '52.173011, -106.634663', '53.598479, -113.574012', '43.831034, -80.535789', '42.2850635, -83.0122264', '44.376942, -64.310916', '43.356378, -79.842898', '50.962489, -114.058674', '45.4713388, -73.8331333', '48.395434, -53.33456', '43.447215, -79.666647', '53.4853882, -113.5165857', '50.4055849, -104.6469818', '43.700773, -79.426644', '48.4274089, -89.2336191', '43.988332, -79.464849', '45.093525, -75.3521829', '42.2561556, -83.0030641', '43.9113236, -80.8678263', '45.5757414, -73.8129751', '49.5080326, -98.0015874', '43.659889, -79.364847', '44.01053, -79.44509', '45.565909, -73.753025', '44.190097, -79.702828', '42.974418, -82.406593', '44.003527, -79.468511', '49.477815, -119.582489', '46.9773003, -70.5592935', '43.877305, -78.941165', '43.661973, -79.518872', '51.704056, -113.26769', '44.768518, -65.399432', '43.216507, -79.756051', '49.24894, -123.101075', '43.142556, -80.733909', '50.255488, -119.262904', '46.08466, -73.172445', '45.921021, -59.970869', '51.0422796, -114.0604845', '45.588596, -62.644672', '53.1996259, -105.7286623', '46.233109, -63.126282', '49.904666, -102.024749', '43.352506, -79.769879', '49.236975, -124.04673', '44.239901, -76.508523', '51.642639, -103.53374', '43.6383952, -80.0271129', '43.650913, -79.759462', '44.8444007, -75.5473659', '54.467145, -126.519327', '43.8029565, -79.4213643', '44.2190952, -79.4449532', '43.703583, -80.365937', '43.8371014, -79.0886387', '45.4971971, -73.6496073', '52.289457, -106.666475', '44.1072478, -79.5960504', '44.727818, -65.506532', '46.095777, -64.746911', '43.574989, -79.738684', '45.4790264, -73.6034121', '48.5493633, -71.6487543', '50.80782, -121.325197', '52.0816018, -109.3947091', '49.1836982, -123.1187337', '43.910557, -78.679219', '51.461738, -112.726391', '44.182332, -76.776813', '50.109914, -120.78764', '45.5775566, -73.4467645', '43.783618, -79.286824', '43.7676842, -79.383108', '45.419377, -75.691743', '43.799159, -79.316986', '53.363844, -113.416092', '49.9082191, -97.0254523', '45.779785, -74.003547', '43.868407, -78.897339', '53.599674, -113.488469', '44.8496608, -75.3169006', '52.326029, -112.707152', '44.315585, -77.829032', '45.397049, -75.747945', '43.641532, -79.414515', '48.427848, -71.0652383', '43.711728, -79.566326', '43.918048, -78.680636', '50.263771, -119.273415', '49.8800962, -119.5371773', '43.662047, -79.383381', '51.0459494, -114.0772372', '42.882169, -79.903915', '45.502435, -73.8422217', '46.809207, -71.368427', '43.646001, -79.385797', '42.312275, -82.870168', '43.825255, -79.299276', '49.1782989, -105.9468637', '43.696378, -79.74867', '49.1251715, -123.1828744', '43.397609, -79.708243', '43.460739, -80.538215', '43.631666, -79.769863', '43.754801, -80.670714', '48.5773524, -123.4489237', '47.51709, -52.806731', '44.4192087, -80.0919211', '43.225854, -79.754311', '46.0892034, -71.3019689', '43.784944, -79.592374', '52.0884485, -106.6466394', '51.210131, -102.457716', '45.402914, -65.973111', '56.066734, -118.384267', '49.170761, -121.95567', '51.124258, -114.20363', '43.006426, -79.252221', '53.456832, -113.434277', '43.49715, -80.550196', '44.3341392, -66.115271', '43.250505, -79.81189', '43.776216, -79.250465', '49.264342, -123.168243', '49.9343915, -97.0968081', '49.895067, -97.13952', '45.5986214, -73.5695038', '49.253955, -122.740395', '53.546327, -113.613776', '50.094035, -108.486458', '49.058473, -122.377569', '63.749907, -68.521321', '48.150288, -80.035441', '52.773635, -108.297568', '43.75576, -79.438145', '54.146991, -125.386512', '54.767008, -101.876951', '49.787834, -97.15741', '42.891615, -82.453167', '45.4798358, -75.5347269', '42.30311, -82.990369', '44.2479905, -76.9492351', '45.42198, -75.42728', '42.929784, -78.917209', '45.4959607, -73.5800121', '45.3263888, -79.2185288', '46.065434, -64.793351', '48.497591, -123.380139', '48.508461, -123.866464', '45.3701375, -75.7709334', '43.766021, -79.411967', '49.953434, -97.076697', '43.8800481, -78.8784986', '43.654529, -79.388033', '43.195944, -79.56821', '49.278616, -81.623073', '43.790645, -80.143912', '45.3076061, -75.0827549', '43.707588, -79.342768', '48.3511767, -84.5473347', '51.0495196, -114.0646195', '53.557792, -113.501443', '43.737443, -79.566001', '45.528646, -73.513207', '46.300591, -83.792253', '44.3099697, -77.9559372', '43.058752, -80.996816', '43.307109, -79.852278', '49.784246, -92.839253', '49.381247, -102.757832', '53.5669271, -113.271902', '43.634743, -79.561547', '43.865828, -79.289922', '44.3331728, -79.6947034', '45.458942, -75.494355', '47.030233, -65.469657', '43.9595859, -78.168072', '44.644354, -81.259065', '49.8253157, -97.2046566', '43.552584, -79.718469', '49.1560206, -122.9132212', '53.477146, -113.373918', '44.4115709, -76.5959126', '50.702005, -119.282941', '50.4475746, -104.570258', '44.092511, -77.766942', '49.19271, -122.800793', '44.0525071, -80.9263979', '43.350189, -81.481054', '43.787117, -79.469729', '52.4111296, -108.7021427', '43.726633, -79.795838', '49.225264, -123.09075', '45.834571, -64.212247', '44.841479, -65.291217', '45.6307819, -73.5905353', '51.0465748, -114.0654341', '45.519547, -73.596175', '48.441181, -123.511134', '43.121888, -79.099613', '52.324848, -112.71129', '43.08936, -79.103831', '51.270993, -114.0129', '44.2379333, -76.5715586', '49.1899262, -98.0987711', '45.4653453, -73.653931', '42.8360185, -80.3036143', '50.422237, -101.047497', '49.2854192, -123.121943', '46.100232, -60.75091', '43.258557, -79.884328', '51.660385, -114.137434', '43.6881363, -79.6170589', '52.835429, -110.859148', '50.4184569, -104.61816', '43.749667, -79.399106', '45.334773, -75.707087', '49.8519963, -100.932885', '51.707047, -113.276441', '49.2693269, -123.1046376', '49.478435, -111.440925', '45.4000519, -72.727023', '43.437021, -80.512207', '45.770065, -79.396887', '42.8819726, -82.1466709', '44.1519958, -81.0282408', '47.5088093, -79.6715369', '48.414688, -123.356441', '53.361773, -104.017964', '45.437365, -75.697196', '43.106639, -79.067357', '54.131876, -108.433259', '51.919381, -109.137144', '46.356255, -72.585857', '44.0602178, -79.4817575', '43.5003959, -80.1887622', '56.754995, -111.462885', '56.719625, -111.357649', '52.05627, -107.985092', '45.06809, -64.443726', '43.645608, -79.394306', '45.4978949, -73.7034087', '45.4927909, -73.5578012', '50.939112, -104.4990046', '45.367165, -71.856579', '43.154858, -80.899512', '44.744126, -65.519594', '44.305848, -81.272883', '44.0791047, -79.78398', '50.9009702, -113.9416854', '49.595357, -99.68447', '49.406741, -123.51929', '46.522072, -80.934336', '50.229469, -99.464238', '50.772425, -99.492245', '43.485119, -79.716716', '53.6109001, -113.3932789', '43.7142367, -79.7250262', '49.214582, -68.1916639', '49.163265, -122.656956', '46.4259067, -81.1433743', '42.177467, -82.8253506', '49.4987945, -119.5924577', '53.670153, -113.638642', '45.4765833, -73.6625949', '50.676005, -120.337309', '46.025722, -73.438827', '44.197201, -77.90186', '43.527649, -65.608957', '45.499805, -73.57368', '53.5812129, -116.4392168', '49.1344019, -122.3067403', '54.730964, -97.800293', '46.0842896, -73.1843337', '45.5903622, -73.6505199', '48.101641, -77.784984', '54.779137, -127.172951', '45.23573, -75.473066', '50.011883, -110.664332', '50.7051555, -113.949511', '44.662732, -63.655264', '50.841056, -101.705117', '49.233148, -123.1056838', '49.1666025, -123.9374757', '49.725271, -86.948552', '43.17578, -79.786642', '49.140108, -123.137777', '43.8604129, -79.490913', '45.2644299, -75.777377', '53.542567, -113.493735', '43.898276, -78.863967', '48.455347, -123.393732', '44.16484, -77.3846967', '48.4264649, -123.3143033', '45.0407397, -79.3094762', '45.256622, -74.1281025', '49.699688, -124.985781', '50.931429, -114.03002', '43.677431, -79.748308', '43.52814, -79.651995', '51.1569255, -114.1623935', '53.645007, -113.623179', '53.437764, -113.605692', '45.4995834, -73.5733204', '49.047065, -122.289611', '45.392033, -76.188955', '44.771381, -76.690256', '43.65035, -79.37229', '49.2802508, -81.6330937', '43.640051, -79.714243', '43.68808, -79.395222', '52.7432254, -109.020974', '45.2944251, -75.8940592', '43.6666102, -79.7816368', '43.846018, -79.378213', '45.614024, -61.362807', '44.900101, -76.249708', '49.410987, -98.659029', '50.027737, -125.245385', '45.3630286, -75.7358149', '46.114742, -60.858123', '42.6644559, -81.5035417', '45.5624782, -73.2067303', '45.635508, -73.584513', '45.359415, -80.040188', '43.649648, -79.384007', '45.4528385, -73.6453311', '45.446351, -73.439733', '45.4681426, -73.6205588', '51.0705043, -104.9518969', '49.68025, -112.803172', '43.8758214, -79.2603122', '43.2579314, -79.9173616', '48.4447517, -123.335289', '45.4158111, -73.4893369', '45.8926853, -74.155023', '50.954102, -114.117306', '45.6750285, -73.4323363', '53.512071, -113.311598', '42.9360862, -81.2808123', '49.277387, -123.1200148', '69.121038, -105.059554', '43.672763, -79.31924', '48.7575069, -91.6220592', '45.577348, -73.447171', '42.961052, -80.0526367', '44.07144, -81.578526', '43.925831, -78.696223', '49.9560181, -97.1454541', '46.3852743, -82.6480963', '50.579993, -113.872522', '54.88115, -100.025303', '49.617932, -100.260252', '43.688458, -79.412633', '43.7322625, -80.9526089', '45.4029282, -65.9734247', '43.706121, -79.312327', '51.503929, -108.498134', '49.879534, -119.443311', '43.853336, -79.633412', '46.8726968, -71.1964979', '49.111517, -121.957856', '45.422987, -75.696693', '43.72732, -79.326444', '45.426827, -75.690289', '50.876553, -114.03692', '51.0452675, -114.1412584', '47.046905, -67.741719', '45.087551, -63.408129', '43.734885, -79.823735', '53.488177, -113.465185', '49.090906, -122.605994', '46.6141648, -81.0074849', '46.5640082, -72.7406159', '44.377765, -64.518972', '45.5013433, -73.5618464', '62.81247, -92.084398', '43.644721, -79.448481', '62.812459, -92.095318', '43.579984, -79.616723', '53.281417, -110.005502', '43.628946, -79.49075', '45.3145855, -73.8739716', '48.407493, -89.260489', '45.4742969, -73.6240176', '45.5033829, -75.6784634', '49.8582897, -97.1061736', '43.765178, -79.280866', '43.524745, -80.285879', '43.252067, -79.939668', '43.654369, -79.422876', '43.609346, -79.744854', '44.7739361, -63.6934325', '53.599416, -113.487716', '43.744176, -79.300357', '42.389519, -82.204357', '42.263079, -82.431915', '43.697643, -79.544289', '52.1146963, -106.6137482', '42.318067, -83.039407', '48.379389, -123.717219', '49.1846515, -123.1363887', '44.665048, -63.567285', '46.0072598, -73.5690862', '45.5116147, -73.5767558', '45.3806226, -75.6685356', '43.415113, -80.509658', '49.146008, -98.950832', '45.4447637, -75.7326824', '51.8507672, -105.0219982', '45.7300371, -67.006534', '46.509471, -84.295767', '45.486645, -73.5888886', '49.2590588, -122.955948', '43.233592, -79.923027', '45.40805, -71.87202', '47.239268, -53.959801', '43.650109, -79.52754', '45.441733, -75.645121', '48.378844, -123.717925', '46.331315, -72.570407', '47.3624184, -68.3276467', '46.452253, -81.004032', '49.82991, -100.2901945', '43.33311, -79.892921', '49.140574, -102.995267', '43.52814, -79.652063', '45.5986269, -74.6115408', '43.192046, -79.811852', '45.607491, -73.6173179', '45.4921036, -73.7104586', '53.603889, -115.019045', '44.1520972, -79.8788401', '43.451306, -80.489407', '44.317211, -78.329767', '45.501889, -73.568463', '43.802101, -79.420605', '45.4952707, -73.4096392', '43.895981, -79.264995', '43.52187, -80.212222', '43.640731, -79.393439', '49.1493288, -122.8902965', '45.7012609, -73.6479071', '50.618428, -108.460229', '47.5195818, -52.9534861', '45.395816, -75.830921', '45.6395136, -73.7877108', '49.2889313, -123.125214', '55.778437, -118.836719', '48.519585, -72.2219108', '44.647997, -63.62015', '43.9255379, -78.8757704', '50.900405, -114.117115', '49.281145, -123.056935', '51.1504755, -100.0489139', '49.0577354, -122.4632111', '42.8851498, -79.0520649', '43.624612, -79.605219', '50.145075, -101.666172', '46.242366, -63.132702', '42.5680516, -81.6831276', '43.8605943, -79.7118712', '43.70427, -79.504156', '44.744209, -63.283321', '44.3557431, -79.6445141', '49.202082, -122.9126195', '45.8260473, -77.1137316', '45.898261, -77.282653', '48.650293, -123.557105', '45.043103, -64.735311', '49.8822518, -97.2942905', '46.7322165, -71.2692763', '53.2985158, -60.3009027', '51.160624, -114.064417', '46.473014, -64.719647', '42.0528904, -82.6007213', '49.24793, -122.892726', '44.420451, -80.080888', '51.0183161, -114.1711592', '53.6287505, -113.5466637', '44.4315246, -75.8854619', '46.1187105, -74.5885519', '47.030642, -65.46942', '55.152371, -118.843097', '46.2224972, -79.3648665', '43.646401, -79.379284', '45.609272, -76.630928', '55.2802907, -114.7716519', '50.391873, -105.536361', '46.123188, -64.853512', '48.786266, -123.706594', '45.501054, -73.561406', '44.9224909, -79.3752116', '43.919589, -80.09553', '43.3704725, -80.9819737', '51.154819, -114.1592427', '45.420775, -75.70065', '46.8360676, -71.2946238', '43.398066, -80.324969', '45.4440747, -73.740912', '54.4436311, -124.2574093', '53.546303, -113.521657', '43.141791, -80.733172', '43.8977244, -80.3149848', '43.383675, -79.801897', '43.672367, -79.469734', '43.793732, -79.239263', '53.711343, -113.212671', '49.250428, -123.127511', '43.0346528, -81.2545535', '42.932634, -81.222468', '43.648019, -79.508154', '43.2594291, -81.1420075', '50.9989926, -113.9806133', '56.23228, -117.290382', '48.9942947, -123.818918', '52.860723, -104.610937', '49.0292285, -119.4477046', '45.5280733, -73.4785376', '53.5180925, -113.4569614', '46.705104, -80.978341', '50.0617758, -96.5141281', '50.284441, -119.268027', '47.9942461, -84.7708625', '45.027857, -74.752374', '43.782022, -79.700026', '44.1000855, -77.5776997', '51.069201, -113.994614', '53.022433, -112.826776', '51.056093, -114.085937', '43.658306, -79.33019', '49.280144, -123.125224', '49.684307, -115.98332', '43.680264, -79.39052', '45.637651, -72.963229', '43.8849068, -79.3724099', '49.163171, -122.65696', '44.1760645, -80.8184387', '48.6099981, -93.3939094', '42.338122, -82.002796', '45.226941, -75.687267', '45.5682701, -73.5898039', '49.8582541, -97.2865508', '53.519528, -113.592807', '48.430044, -123.41064', '43.6412281, -79.376648', '48.6512583, -72.4443132', '50.4038703, -105.5345222', '48.9485918, -55.6541617', '42.43937, -81.886876', '43.647305, -79.403523', '43.703494, -79.36902', '43.929995, -79.522376', '42.926517, -80.603188', '43.370841, -80.948716', '44.970353, -63.505652', '44.7545029, -78.0862763', '42.860419, -80.727619', '55.756904, -120.229637', '45.293066, -75.214167', '52.1255316, -106.7588229', '43.698729, -65.113393', '49.1759911, -122.8901749', '49.830966, -119.62371', '49.2741431, -123.1213228', '44.0789113, -79.7847957', '49.5262849, -96.6846066', '43.433539, -79.702685', '45.5340808, -74.9942424', '46.6527835, -80.9892298', '43.446236, -65.633225', '43.476065, -80.524937', '43.727028, -79.4822195', '53.540889, -113.494193', '43.0989541, -79.5465064', '43.136079, -79.214824', '43.755573, -79.24511', '44.750225, -79.885616', '53.618624, -113.491743', '50.9022022, -114.0648998', '48.365088, -89.281795', '53.993949, -97.768106', '43.706485, -79.693385', '46.6491766, -81.3919914', '44.624003, -65.756596', '45.2754682, -75.7193605', '45.4348727, -75.7811127', '43.689024, -79.620442', '43.902253, -78.843493', '51.178506, -115.574277', '44.657235, -63.63218', '53.3657356, -113.7287065', '43.818246, -79.116601', '46.146887, -67.574317', '45.385672, -75.735223', '48.477168, -81.328158', '43.700387, -79.516997', '49.7004545, -123.1534282', '53.627032, -113.411787', '45.127195, -75.710805', '50.699047, -120.362493', '43.746097, -79.48673', '45.408413, -74.033412', '45.447095, -73.287885', '50.438542, -100.5925', '43.1803006, -80.2806433', '51.0457308, -114.0689234', '55.24725, -127.586248', '45.1445175, -61.9946622', '43.406201, -79.807624', '56.7195028, -111.3573296', '45.3867478, -75.6797883', '49.230224, -100.055894', '43.710231, -79.3631', '42.886202, -79.252298', '45.4203, -75.700596', '47.5245184, -52.7712409', '46.794027, -71.179808', '49.14534, -122.648246', '44.7083366, -75.5162532', '50.9316866, -113.9594899', '42.8164629, -81.5526778', '53.9003079, -122.7777067'];

//We create a dictionary which will hold: [user:{rounds, pointsAccumulated}]
dictRounds = {};
dictPoints = {};


function inRange(x, min, max) {
    return (min <= x && x <= max);
}

// check if PRIVATE_KEY is defined
if (!process.env.PRIVATE_KEY) {
    console.error('[ERROR]: PRIVATE_KEY is not defined.');
    process.exit(1);
}

// start connection to MongoDB
mongo.InitiateMongoServer();

const app = express();
app.use(express.json());
app.use(cookieParser());
app.disable('x-powered-by');
app.use('/user', users);
app.use('/game', games);
app.use('/auth', auth);
app.use(express.static(path.join(__dirname, 'public')));

app.set('view engine', 'ejs');

app.listen(process.env.PORT || 3001, () => {
    console.log('listening at 3001')
});

app.get('/', jwt_auth, function (request, response) {
    response.render('pages/index', {
        isLoggedIn: request.logged
    });
});

app.get('/contact/', jwt_auth, function (request, response) {
    response.render('pages/contact', {
        isLoggedIn: request.logged
    });
});

app.get('/leaderboard/', jwt_auth, function (request, response) {
    response.render('pages/leaderboard', {
        isLoggedIn: request.logged
    });
});

app.get('/play/', jwt_auth, function (request, response) {
    response.render('pages/play', {
        isLoggedIn: request.logged
    });
});

app.get('/registration/', jwt_auth, function (request, response) {
    response.render('pages/registration', {
        isLoggedIn: request.logged
    });
});

app.get('/login/', jwt_auth, function (request, response) {
    response.render('pages/login', {
        isLoggedIn: request.logged
    });
});

app.get('/auth/forgotpassword/', jwt_auth, function (request, response) {
    response.render('pages/forgotpassword', {
        isLoggedIn: request.logged
    });
});

app.get('/auth/reset/:token', function (request, response) {
    User.findOne({
        resetLink: request.params.token
    }, function (err, user) {
        if (!user) {
            alert('Password reset token is invalid or has expired.');
            return response.redirect('/auth/forgotpassword/');
        }
        response.render('pages/reset', {
            isLoggedIn: request.logged
        });
    });
});


app.get('/logout/', function (request, response) {
    response.cookie('token', {}, {
        maxAge: -1
    });
    response.redirect('/')
});

app.post('/guess', jwt_auth, async function (req, res) {
    var token = req.header('Cookie');
    var my_jwt = token.split(/=(.+)/)[1];
    var decoded = jwt.verify(my_jwt, process.env.PRIVATE_KEY);
    var redirectBool = false;
    // we will receive the latitude and longitude
    data = req.body;
    // for the moment the goal latitude and longitude is hardcoded
    const R = 6371000; // meters
    const phi1 = data.lat * Math.PI / 180; // φ, λ in radians, ç
    const phi2 = data.latGoal * Math.PI / 180;
    const dphi = (data.latGoal - data.lat) * Math.PI / 180;
    const dlambda = (data.lngGoal - data.lng) * Math.PI / 180;

    const a = Math.sin(dphi / 2) * Math.sin(dphi / 2) + Math.cos(phi1) * Math.cos(phi2) * Math.sin(dlambda / 2) * Math.sin(dlambda / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    const d = R * c; // in meters
    distance = Math.ceil(d / 1000);

    // now that we have the distance in kilometers, let's compute the points
    var points = 0.0
    if (inRange(distance, 1, 2)) {
        points = 10000.0;
    }
    if (distance >= 5000) {
        points = 0.0;
    } else {
        points = (-2.2492956868105) * distance + 10004.49859137362;
    }

    points = Math.round(points);

    //Now we will get the token and from it the _id
    var my_jwt = token.split(/=(.+)/)[1];
    decoded = jwt.verify(my_jwt, process.env.PRIVATE_KEY);
    var id = decoded['_id'];
    //With the id we will extract the username
    let user = await User.findOne({ _id: id });
    if (user) {
        unameJSON = (_.pick(user, 'username'));
        username = unameJSON.username;
    }
    //Now that we have the username we will check if it is in the dictionaries
    if(!(username in dictRounds)){
        //Then we add an entry with 1 round since this is the first one
        dictRounds[username] = 1;
        dictPoints[username] = points;
        redirectBool = false;
    }else{
        //If the username is in the dictionary then we add 1 to the rounds and add the points
        if(dictRounds[username] < 3){
            dictRounds[username]++;
            dictPoints[username]+= points;
            if(dictRounds[username] == 3){
                //If the number of rounds is 3 then we stop the game, and store the points in the array.
                console.log("The 3 rounds have been played!");
                //We store the pair [username, dictPoints[username]]

                let user = await User.findOne({ username: username });
                if (user) {
                    // pick values of those keys from the body (lodash)
                    game = new Game({
                        username: username,
                        score: dictPoints[username]
                    });
                    await game.save();
                }
                //We clear the dictionary of it's values, leaving room for the next game
                dictPoints[username] = 0;
                dictRounds[username] = 0;
                redirectBool = true;
            }else{
                redirectBool = false;
            }
        }
    }
    console.log(dictRounds);
    console.log(dictPoints);

    response = {
        points: points,
        distance: distance,
        redirect: redirectBool
    };

    //We will also load the points and add 1 to the 
    res.json(response);
});

app.post('/skip', jwt_auth, async function (req, res){
    var redirectBool = false;
    //When the user does a POST request to skip we add a round to his 
    var token = req.header('Cookie');
    var my_jwt = token.split(/=(.+)/)[1];
    var decoded = jwt.verify(my_jwt, process.env.PRIVATE_KEY);
    var id = decoded['_id'];
    let user = await User.findOne({ _id: id });
    if (user) {
        unameJSON = (_.pick(user, 'username'));
        username = unameJSON.username;
    }
        //Now that we have the username we will check if it is in the dictionaries
    if(!(username in dictRounds)){
        //Then we add an entry with 1 round since this is the first one
        dictRounds[username] = 1;
        dictPoints[username] = 0;
        redirectBool = false;
    }else{
        //Add 1 to the roundsPlayed
        dictRounds[username]++;
        console.log(dictRounds[username]);
        redirectBool = false;
        if(dictRounds[username] == 3){
            //We change the redirectBool
            redirectBool = true;

            let user = await User.findOne({ username: username });
                if (user) {
                    // pick values of those keys from the body (lodash)
                    game = new Game({
                        username: username,
                        score: dictPoints[username]
                    });
                    await game.save();
                }

            dictRounds[username] = 0;
            dictPoints[username] = 0;
            
        }
    }

    response = {
        redirect: redirectBool
    };

    res.json(response);
});

app.get('/goal', jwt_auth, (req, res) => {
    // first we get the random coordinates
    var randCoord = coordArray[Math.floor(Math.random() * coordArray.length)];

    // now we have a coord, e.g. '45.5879673, -73.6341011'
    coordArrayLatLongs = randCoord.replace(/ [\])}[{(] /g, '').split(',');
    console.log(coordArrayLatLongs);

    // we create the JSON we will send back to the user
    var coords = {
        lat: coordArrayLatLongs[0],
        lng: coordArrayLatLongs[1]
    };
    latGoal = coordArrayLatLongs[0];
    lngGoal = coordArrayLatLongs[1];
    res.json(coords);
});

app.get('/goal/get', jwt_auth, (req, res) => {
    var coords = {
        lat: latGoal,
        lng: lngGoal
    };
    res.json(coords);
});


app.post('/points', jwt_auth, (req, res) => {
    // we will store the points of the user with it's id
    var token = req.header('Cookie');

    // let's extract the points too
    data = req.body;
    points = data.points;

    // to get just the token (splits after =)
    var my_jwt = token.split(/=(.+)/)[1];
    decoded = jwt.verify(my_jwt, process.env.PRIVATE_KEY);
    pointsArray.push([decoded['_id'], points]);
    res.send('Your point total was sent to the server!');
});

module.exports = app;